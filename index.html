<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Aplikasi Kas Gereja</title>

<style>
  body {
    font-family: "Segoe UI", Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #f5f6fa;
  }

  header {
    background: #0b74de;
    padding: 18px;
    color: white;
    text-align: center;
    font-size: 22px;
    font-weight: 600;
  }

  .container {
    max-width: 900px;
    margin: auto;
    padding: 18px;
  }

  .card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 22px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }

  .card h2 {
    margin-top: 0;
    font-size: 20px;
    color: #0b74de;
    margin-bottom: 12px;
  }

  label {
    font-weight: 600;
    margin-top: 12px;
    display: block;
  }

  input, select {
    padding: 10px;
    width: 100%;
    border-radius: 6px;
    border: 1px solid #ccc;
    margin-top: 4px;
    font-size: 15px;
  }

  button {
    background: #0b74de;
    color: white;
    padding: 12px 18px;
    border: none;
    border-radius: 8px;
    margin-top: 14px;
    cursor: pointer;
    font-size: 15px;
    width: 100%;
  }

  button:hover {
    background: #095fb7;
  }

  .btn-sm {
    display: inline-block;
    background: #0b74de;
    padding: 8px 14px;
    border-radius: 6px;
    color: white;
    text-decoration: none;
    font-size: 14px;
    margin-top: 10px;
  }

  .table-wrapper {
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 14px;
  }

  th, td {
    padding: 10px;
    border-bottom: 1px solid #e1e4ea;
    text-align: left;
  }

  th {
    background: #eaf2ff;
    font-weight: 600;
  }

  .right {
    text-align: right;
  }

  #msg {
    margin-top: 8px;
    font-weight: bold;
    color: green;
  }

  /* Loading blink */
  #loading b, #loadingLaporan b {
    animation: blink 1s infinite;
  }

  @keyframes blink {
    0% { opacity: 0.2; }
    50% { opacity: 1; }
    100% { opacity: 0.2; }
  }

  /* Modal */
  .modal-backdrop {
    position: fixed; inset: 0; background: rgba(0,0,0,0.4);
    display: none; align-items: center; justify-content: center; z-index: 9999;
  }
  .modal-card {
    background: white; padding: 18px; border-radius: 8px; width: 95%; max-width: 420px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.2);
  }
  .modal-card label { font-weight:600; margin-top:8px; display:block; }
  .modal-card input, .modal-card select { width:100%; padding:8px; margin-top:6px; border-radius:6px; border:1px solid #ccc;}
  .modal-actions { margin-top:12px; display:flex; gap:8px; }
  .btn-cancel { background:#ccc; color:#111; padding:8px 10px; border-radius:6px; cursor:pointer; border:none; flex:1; }
  .btn-save { background:#0b74de; color:white; padding:8px 10px; border-radius:6px; cursor:pointer; border:none; flex:1; }
</style>

</head>
<body>

<header>
  Aplikasi Buku Kas Gereja
</header>

<div class="container">

  <!-- ========================= FORM INPUT ========================= -->
  <div class="card">
    <h2>Input Transaksi</h2>

    <form id="formKas">
      <label>Tanggal</label>
      <input type="date" name="tanggal" required>

      <label>Uraian</label>
      <input type="text" name="uraian" required>

      <label>Jenis</label>
      <select name="jenis">
        <option value="Penerimaan">Penerimaan</option>
        <option value="Pengeluaran">Pengeluaran</option>
      </select>

      <label>Nominal</label>
      <input type="number" name="nominal" required>

      <button type="submit">Simpan Transaksi</button>
    </form>

    <div id="loading" style="display:none; padding:10px; text-align:center;">
      <b>Sedang memproses...</b>
    </div>

    <div id="msg"></div>
  </div>

  <!-- ========================= FILTER & LAPORAN ========================= -->
  <div class="card">
    <h2>Laporan Bulanan</h2>

    <label>Pilih Bulan</label>
    <select id="bulan"></select>

    <label>Tanggal Laporan</label>
    <input type="date" id="tanggalLaporan">

    <button id="lihat">Tampilkan Laporan</button>
    <a href="#" class="btn-sm" onclick="window.print()">Cetak / PDF</a>

    <div id="loadingLaporan" style="display:none; padding:10px; text-align:center;">
      <b>Memuat laporan...</b>
    </div>

    <div id="laporan"></div>
  </div>

</div>


<script>
/* ======================= KONFIGURASI URL ======================= */
const APP_POST_URL = "https://script.google.com/macros/s/AKfycbw54wej60UYkvjTXfb7WNCLG-2LQEjM4KINEJCT8IDIUtGPKvZnTR5k2aUrTWbHWbG2/exec";
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR6SHdMmw12HIgkj1VrsZRSjHrQPzlDMceBg4zOGYp5V6GimreVYVt71pgKVWC1fmA428NkQYfs5Jaw/pub?gid=0&single=true&output=csv";
const CONFIG_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR6SHdMmw12HIgkj1VrsZRSjHrQPzlDMceBg4zOGYp5V6GimreVYVt71pgKVWC1fmA428NkQYfs5Jaw/pub?gid=747260588&single=true&output=csv";


/* ======================= SIMPAN DATA ======================= */
document.getElementById("formKas").addEventListener("submit", async (e) => {
  e.preventDefault();
  const form = new FormData(e.target);

  document.getElementById("loading").style.display = "block";
  document.getElementById("msg").innerHTML = "";

  const res = await fetch(APP_POST_URL, { method: "POST", body: form });
  document.getElementById("msg").innerHTML = await res.text();
  document.getElementById("loading").style.display = "none";
  e.target.reset();
});


/* ======================= CSV PARSER ======================= */
function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  const header = lines[0].split(",");
  const rows = [];
  for(let i=1;i<lines.length;i++){
    let cols = lines[i].split(",");
    let obj = {};
    header.forEach((h,idx)=> obj[h.trim()] = cols[idx]?.trim() || "");
    rows.push(obj);
  }
  return rows;
}

function monthName(n){
  const m=["","Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","Nopember","Desember"];
  return m[n];
}

async function loadConfig(){
  const res = await fetch(CONFIG_URL,{cache:"no-store"});
  const raw = parseCSV(await res.text());
  let cfg={}; raw.forEach(r=> cfg[r.key]=r.value);
  return cfg;
}


/* ======================= LOAD & RENDER LAPORAN ======================= */
async function loadAndRender(month){

  document.getElementById("loadingLaporan").style.display = "block";

  const cfg = await loadConfig();
  const tanggalDipilih = document.getElementById("tanggalLaporan").value;

  let tanggalFormatted = "";
  if(tanggalDipilih){
    let t = new Date(tanggalDipilih);
    tanggalFormatted = t.toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});
  }

  const raw = parseCSV(await (await fetch(CSV_URL,{cache:"no-store"})).text());

  let tx = raw.map(r => ({
    id:Number(r.id),
    tanggal:r.tanggal,
    uraian:r.uraian,
    jenis:r.jenis,
    nominal:Number(r.nominal),
    bulan:Number(r.bulan),
    tahun:Number(r.tahun)
  })).filter(t => t.bulan == month);

  const rawPrev = parseCSV(await (await fetch(CSV_URL,{cache:"no-store"})).text());
  let prev = rawPrev.filter(r=> Number(r.bulan)==(month-1));

  let saldoAwal=0;
  prev.forEach(p=>{
    if(p.jenis=="Penerimaan") saldoAwal+=Number(p.nominal);
    if(p.jenis=="Pengeluaran") saldoAwal-=Number(p.nominal);
  });

  let totalIn=0,totalOut=0;
  let saldo = saldoAwal;

  /* ===== HEADER LAPORAN ===== */
  let html = `
    <div style="text-align:center;">
      <img src="${cfg.header_url}" style="max-width:600px;width:100%;">
    </div>

    <h2 style="text-align:center;margin:5px 0;">
      Buku Kas Umum<br>${cfg.subyek}
    </h2>

    <br>

    <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>No</th>
          <th>Tgl</th>
          <th>Uraian</th>
          <th class="right">Penerimaan</th>
          <th class="right">Pengeluaran</th>
          <th class="right">Saldo</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody>
  `;

  /* ===== SALDO AWAL ===== */
  html += `
    <tr style="font-weight:bold;background:#f6f7f9;">
      <td>1</td>
      <td></td>
      <td>Saldo Awal Bulan</td>
      <td></td>
      <td></td>
      <td class="right">${saldo.toLocaleString()}</td>
      <td></td>
    </tr>
  `;

  /* ===== SIMPAN TRANSAKSI UNTUK CRUD ===== */
  window.currentTransactions = tx;

  /* ===== TRANSAKSI ===== */
  tx.forEach((t,i)=>{
    let masuk = t.jenis=="Penerimaan"? t.nominal : 0;
    let keluar = t.jenis=="Pengeluaran"? t.nominal : 0;

    saldo += masuk - keluar;
    totalIn += masuk;
    totalOut += keluar;

    html += `
      <tr>
        <td>${i+2}</td>
        <td>${t.tanggal}</td>
        <td>${t.uraian}</td>
        <td class="right">${masuk? masuk.toLocaleString():""}</td>
        <td class="right">${keluar? keluar.toLocaleString():""}</td>
        <td class="right">${saldo.toLocaleString()}</td>
        <td>
          <button onclick="editTransaksi(${t.id})" style="padding:5px 10px;border-radius:6px;margin-right:4px;">Edit</button>
          <button onclick="hapusTransaksi(${t.id})" style="padding:5px 10px;border-radius:6px;background:#c0392b;color:white;border:none;">Hapus</button>
        </td>
      </tr>
    `;
  });


  /* ===== FOOTER ===== */
  html += `
      </tbody>
      <tfoot>
        <tr style="font-weight:bold;background:#eaf2ff;">
          <td colspan="3" class="right">Jumlah</td>
          <td class="right">${totalIn.toLocaleString()}</td>
          <td class="right">${totalOut.toLocaleString()}</td>
          <td class="right">${saldo.toLocaleString()}</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
    </div>

    <br><br><br>

    <div style="text-align:right;margin-bottom:40px;">
        ${cfg.lokasi}, ${tanggalFormatted}
    </div>

    <table style="width:100%;">
      <tr>
        <td style="text-align:center;">
            Ketua,<br><br><br>
            <b>${cfg.ketua}</b>
        </td>
        <td style="text-align:center;">
            Bendahara,<br><br><br>
            <b>${cfg.bendahara}</b>
        </td>
      </tr>
    </table>
  `;

  document.getElementById("laporan").innerHTML = html;
  document.getElementById("loadingLaporan").style.display = "none";
}


/* ======================= EDIT ======================= */
function editTransaksi(id){
  const t = window.currentTransactions.find(x=> Number(x.id)==Number(id));
  if(!t){ alert("Data tidak ditemukan"); return; }

  document.getElementById("edit_id").value = t.id;
  document.getElementById("edit_tanggal").value = t.tanggal;
  document.getElementById("edit_uraian").value = t.uraian;
  document.getElementById("edit_jenis").value = t.jenis;
  document.getElementById("edit_nominal").value = t.nominal;

  document.getElementById("modalEditBackdrop").style.display = "flex";
}

function closeEditModal(){
  document.getElementById("modalEditBackdrop").style.display = "none";
}

async function updateData(){
  const id = document.getElementById("edit_id").value;
  const fd = new FormData();

  fd.append("action","update");
  fd.append("id", id);
  fd.append("tanggal", document.getElementById("edit_tanggal").value);
  fd.append("uraian", document.getElementById("edit_uraian").value);
  fd.append("jenis", document.getElementById("edit_jenis").value);
  fd.append("nominal", document.getElementById("edit_nominal").value);

  const res = await fetch(APP_POST_URL,{method:"POST",body:fd});
  const js = await res.json();

  if(js.status=="success"){
    closeEditModal();
    const m = Number(document.getElementById("bulan").value);
    await loadAndRender(m);
    alert("Perubahan disimpan.");
  } else {
    alert("Gagal update: "+js.message);
  }
}


/* ======================= DELETE ======================= */
async function hapusTransaksi(id){
  let alasan = prompt("Alasan penghapusan?");
  if(alasan === null) return;

  const fd = new FormData();
  fd.append("action","delete");
  fd.append("id", id);
  fd.append("alasan", alasan);

  const res = await fetch(APP_POST_URL,{method:"POST",body:fd});
  const js = await res.json();

  if(js.status=="success"){
    const m = Number(document.getElementById("bulan").value);
    await loadAndRender(m);
    alert("Transaksi dihapus.");
  } else {
    alert("Gagal hapus: "+js.message);
  }
}


/* ======================= DROPDOWN & TOMBOL ======================= */
function initMonthDropdown(){
  const sel = document.getElementById("bulan");
  for(let i=1;i<=12;i++){
    const o=document.createElement("option");
    o.value=i; o.textContent=monthName(i);
    sel.appendChild(o);
  }
}
initMonthDropdown();

document.getElementById("lihat").addEventListener("click", async()=>{
  const m = Number(document.getElementById("bulan").value);
  document.getElementById("laporan").innerHTML="";
  document.getElementById("loadingLaporan").style.display="block";
  await loadAndRender(m);
});
</script>


<!-- ======================= MODAL EDIT ======================= -->
<div id="modalEditBackdrop" class="modal-backdrop">
  <div class="modal-card">
    <h3>Edit Transaksi</h3>

    <input type="hidden" id="edit_id">

    <label>Tanggal</label>
    <input type="date" id="edit_tanggal">

    <label>Uraian</label>
    <input type="text" id="edit_uraian">

    <label>Jenis</label>
    <select id="edit_jenis">
      <option value="Penerimaan">Penerimaan</option>
      <option value="Pengeluaran">Pengeluaran</option>
    </select>

    <label>Nominal</label>
    <input type="number" id="edit_nominal">

    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeEditModal()">Batal</button>
      <button class="btn-save" onclick="updateData()">Simpan</button>
    </div>
  </div>
</div>

</body>
</html>
