<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Aplikasi Kas Umum Jemaat GKE Yerusalem Tamiang Layang</title>

<style>
/* ---------- Basic ---------- */
body { font-family: "Segoe UI", Arial, sans-serif; margin:0; padding:0; background:#f5f6fa; color:#222; }
.container { max-width: 1000px; margin: 18px auto; padding: 12px; }
.card { background:white; padding:18px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.06); margin-bottom:18px; }

/* ---------- Header ---------- */
.header-img { width:100%; max-width:600px; height:auto; margin:0 auto 8px; display:block; }
.app-header { text-align:center; padding:18px 10px; background:#0b74de; color:white; border-bottom:4px solid rgba(0,0,0,0.04); }
.app-header .title { font-size:20px; font-weight:700; }
.app-header .subtitle { font-size:14px; opacity:0.95; margin-top:6px; }

/* ---------- Form ---------- */
label { display:block; margin-top:10px; font-weight:600; }
input, select { width:100%; padding:10px; border-radius:6px; border:1px solid #ccc; margin-top:6px; font-size:15px; box-sizing:border-box; }
button { background:#0b74de; color:white; padding:10px 14px; border:none; border-radius:8px; cursor:pointer; }
.btn-sm { display:inline-block; background:#0b74de; color:white; padding:8px 12px; border-radius:6px; text-decoration:none; }

/* ---------- Table ---------- */
.table-wrapper { overflow-x:auto; margin-top:12px; }
table { width:100%; border-collapse:collapse; }
th, td { padding:10px 8px; border-bottom:1px solid #e9eef6; text-align:left; vertical-align:middle; }
th { background:#eef6ff; font-weight:600; }
.right { text-align:right; }

/* ---------- Loading ---------- */
#loading, #loadingLaporan { display:none; text-align:center; padding:10px; margin-top:8px; color:#0b74de; font-weight:700; }
#loading b, #loadingLaporan b { animation: blink 1s infinite; }
@keyframes blink { 0%{opacity:.2}50%{opacity:1}100%{opacity:.2} }

/* ---------- Modal ---------- */
.modal-backdrop { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.35); z-index:9999; }
.modal-card { background:white; width:95%; max-width:480px; padding:16px; border-radius:8px; box-shadow:0 10px 40px rgba(0,0,0,0.15); }

/* ---------- Print / A4 ---------- */
@media print {
  @page { size: A4 portrait; margin:20mm; }
  body * { visibility: hidden !important; }
  #laporan, #laporan * { visibility: visible !important; }
  #laporan { position: absolute; left:0; top:0; width:100%; }
  table { page-break-inside:auto; }
  tr { page-break-inside:avoid; page-break-after:auto; }
  thead { display: table-header-group; }
  tfoot { display: table-footer-group; }
}

@media print {
  #laporan .table-wrapper { overflow:visible; }
  #laporan table { width:100%; font-size:12px; }
}

/* ---------- Others ---------- */
.btn-danger { background:#c0392b; color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
.small { font-size:13px; color:#666; }
.center { text-align:center; }

.sign-area { margin-top:36px; width:100%; display:flex; justify-content:space-between; gap:20px; }
.sign-area .box { text-align:center; width:48%; }

@media (max-width:600px){
  .app-header .title { font-size:18px; }
  .header-img { max-width:320px; }
}
</style>
</head>

<body>

<!-- HEADER ATAS -->
<div class="app-header">
  <img id="headerImageTop" class="header-img" src="" alt="Header" />
  <div class="title">Aplikasi Buku Kas Umum</div>
  <div id="headerSubyekTop" class="subtitle"></div>
</div>

<div class="container">
  <!-- ========================= FORM INPUT ========================= -->
  <div class="card">
    <h3>Input Transaksi</h3>
    <form id="formKas">
      <label>Tanggal</label>
      <input type="date" name="tanggal" required>

      <label>Uraian</label>
      <input type="text" name="uraian" required>

      <label>Jenis</label>
      <select name="jenis">
        <option value="Penerimaan">Penerimaan</option>
        <option value="Pengeluaran">Pengeluaran</option>
      </select>

      <label>Nominal</label>
      <input type="text" name="nominal" placeholder="Masukkan angka tanpa titik" required>

      <button type="submit">Simpan Transaksi</button>
    </form>

    <div id="loading" class="small"><b>Sedang memproses...</b></div>
    <div id="msg" class="small"></div>
  </div>


  <!-- ========================= FILTER & LAPORAN ========================= -->
  <div class="card">
    <h3>Laporan Bulanan</h3>

    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <div style="flex:1; min-width:150px;">
        <label>Pilih Bulan</label>
        <select id="bulan"></select>
      </div>

      <div style="width:150px;">
        <label>Pilih Tahun</label>
        <select id="tahun"></select>
      </div>

      <div style="width:220px;">
        <label>Tanggal Laporan (untuk cetak)</label>
        <input type="date" id="tanggalLaporan">
      </div>

      <div style="min-width:140px; align-self:end;">
        <button id="lihat">Tampilkan Laporan</button>
      </div>

      <div style="min-width:140px; align-self:end;">
        <a class="btn-sm" id="cetakBtn" href="#" onclick="window.print()">Cetak / PDF</a>
      </div>
    </div>

    <div id="loadingLaporan" class="small"><b>Memuat laporan...</b></div>
    <div id="laporan" style="margin-top:12px;"></div>
  </div>

</div> <!-- END OF CONTAINER -->


<!-- ========================= MODAL EDIT ========================= -->
<div id="modalEditBackdrop" class="modal-backdrop">
  <div class="modal-card">
    <h3>Edit Transaksi</h3>

    <input type="hidden" id="edit_id">

    <label>Tanggal</label>
    <input type="date" id="edit_tanggal">

    <label>Uraian</label>
    <input type="text" id="edit_uraian">

    <label>Jenis</label>
    <select id="edit_jenis">
      <option value="Penerimaan">Penerimaan</option>
      <option value="Pengeluaran">Pengeluaran</option>
    </select>

    <label>Nominal</label>
    <input type="text" id="edit_nominal">

    <div style="display:flex; gap:8px; margin-top:12px;">
      <button class="btn-cancel" onclick="closeEditModal()">Batal</button>
      <button class="btn-save" onclick="updateData()">Simpan</button>
    </div>
  </div>
</div>
<script>
/* ================= Configuration - ganti jika perlu ================= */
const APP_POST_URL = "https://script.google.com/macros/s/AKfycbw54wej60UYkvjTXfb7WNCLG-2LQEjM4KINEJCT8IDIUtGPKvZnTR5k2aUrTWbHWbG2/exec";
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR6SHdMmw12HIgkj1VrsZRSjHrQPzlDMceBg4zOGYp5V6GimreVYVt71pgKVWC1fmA428NkQYfs5Jaw/pub?gid=0&single=true&output=csv";
const CONFIG_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR6SHdMmw12HIgkj1VrsZRSjHrQPzlDMceBg4zOGYp5V6GimreVYVt71pgKVWC1fmA428NkQYfs5Jaw/pub?gid=747260588&single=true&output=csv";

/* ================= helper: remove surrounding quotes & trim ================= */
function cleanQuotes(s){
  if(s === null || s === undefined) return "";
  return String(s).replace(/^"+|"+$/g, "").trim();
}

/* ================= robust CSV parser (handles quotes, commas, multiline) ================= */
function parseCSV(text){
  if(!text) return [];
  // normalize endings
  text = text.replace(/\r\n/g, "\n");
  const rows = [];
  let inside = false, cur = "", row = [];

  for(let i=0;i<text.length;i++){
    const ch = text[i];
    if(ch === '"'){
      // handle double quotes escaping
      const next = text[i+1];
      if(inside && next === '"'){
        cur += '"';
        i++;
        continue;
      }
      inside = !inside;
      continue;
    }
    if(ch === ',' && !inside){
      row.push(cur);
      cur = "";
      continue;
    }
    if(ch === '\n' && !inside){
      row.push(cur);
      cur = "";
      rows.push(row);
      row = [];
      continue;
    }
    cur += ch;
  }
  // last field (if no newline at end)
  if(cur !== "" || row.length > 0){
    row.push(cur);
    rows.push(row);
  }

  if(rows.length === 0) return [];
  const header = rows.shift().map(h => cleanQuotes(h).trim());

  return rows.map(r=>{
    const obj = {};
    for(let i=0;i<header.length;i++){
      obj[header[i]] = cleanQuotes((r[i] !== undefined) ? r[i] : "");
    }
    return obj;
  });
}

/* ================= small helpers ================= */
function monthName(n){
  const m=["","Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","Nopember","Desember"];
  return m[n] || "";
}
function escapeHtml(s){
  if(!s) return "";
  return String(s).replace(/[&<>"']/g, function(ch){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[ch]; });
}
function toNumberNominal(s){
  if(s === null || s === undefined) return 0;
  // remove all non-digit and non-minus
  let cleaned = String(s).replace(/[^\d\-]/g, '');
  if(cleaned === "") return 0;
  return Number(cleaned);
}

/* ================= load config (header, subyek, ketua, bendahara, lokasi) ================= */
async function loadConfig(){
  try{
    const res = await fetch(CONFIG_URL, { cache: 'no-store' });
    const txt = await res.text();
    const arr = parseCSV(txt);
    const cfg = {};
    arr.forEach(r => {
      if(r.key !== undefined){
        cfg[r.key] = cleanQuotes(r.value || "");
      }
    });
    return cfg;
  }catch(err){
    console.error('loadConfig error', err);
    return {};
  }
}

async function applyHeaderConfig(){
  const cfg = await loadConfig();
  if(cfg.header_url) document.getElementById('headerImageTop').src = cfg.header_url;
  if(cfg.subyek) document.getElementById('headerSubyekTop').innerText = cleanQuotes(cfg.subyek);
}

/* ================= load all transaksi dari CSV dan normalisasi ================= */
async function loadAllTransactions(){
  const res = await fetch(CSV_URL, { cache: 'no-store' });
  const txt = await res.text();
  const arr = parseCSV(txt); // array of objects

  // map keys flexibly and clean values
  return arr.map(r => {
    const keys = Object.keys(r);
    const find = (k) => keys.find(x=> x.toLowerCase() === k) || null;

    const idKey = find('id');
    const tanggalKey = find('tanggal');
    const uraianKey = find('uraian');
    const jenisKey = find('jenis');
    const nominalKey = find('nominal');
    const bulanKey = find('bulan');
    const tahunKey = find('tahun');

    const rawTanggal = tanggalKey ? r[tanggalKey] : "";
    const rawUraian = uraianKey ? r[uraianKey] : "";
    const rawJenis = jenisKey ? r[jenisKey] : "";
    const rawNominal = nominalKey ? r[nominalKey] : "";
    const rawBulan = bulanKey ? r[bulanKey] : "";
    const rawTahun = tahunKey ? r[tahunKey] : "";

    // try parse date if bulan/tahun missing
    let parsedDate = rawTanggal ? new Date(rawTanggal) : new Date(NaN);
    let bulan = parseInt(rawBulan) || (isNaN(parsedDate.getMonth()) ? 0 : parsedDate.getMonth() + 1);
    let tahun = parseInt(rawTahun) || (isNaN(parsedDate.getFullYear()) ? new Date().getFullYear() : parsedDate.getFullYear());

    return {
      raw: r,
      id: idKey ? (r[idKey] || "") : "",
      tanggal: rawTanggal || "",
      uraian: rawUraian || "",
      jenis: rawJenis || "",
      nominal: toNumberNominal(rawNominal),
      bulan: Number(bulan),
      tahun: Number(tahun)
    };
  });
}

/* ================= hitung saldo awal = akumulasi semua bulan sebelum target ================= */
function hitungSaldoAwalSemua(semuaData, targetMonth, targetYear){
  let saldo = 0;
  semuaData.forEach(r => {
    // only consider records that happened before target month/year
    if( (r.tahun < targetYear) || (r.tahun === targetYear && r.bulan < targetMonth) ){
      if(String(r.jenis).trim() === "Penerimaan") saldo += Number(r.nominal);
      if(String(r.jenis).trim() === "Pengeluaran") saldo -= Number(r.nominal);
    }
  });
  return saldo;
}

/* ================= render laporan (ada tulisan Bulan <nama> <tahun>) ================= */
async function loadAndRender(month, year){
  try{
    document.getElementById('loadingLaporan').style.display = 'block';
    const cfg = await loadConfig();
    const tanggalDipilih = document.getElementById('tanggalLaporan').value;
    let tanggalFormatted = "";
    if(tanggalDipilih){
      const d = new Date(tanggalDipilih);
      tanggalFormatted = d.toLocaleDateString('id-ID', { day:'numeric', month:'long', year:'numeric' });
    } else {
      tanggalFormatted = new Date().toLocaleDateString('id-ID', { day:'numeric', month:'long', year:'numeric' });
    }

    const semua = await loadAllTransactions();

    // saldo awal (akumulasi seluruh transaksi sebelum month/year)
    const saldoAwal = hitungSaldoAwalSemua(semua, month, year);

    // ambil transaksi bulan/year
    let tx = semua.filter(r => Number(r.bulan) === Number(month) && Number(r.tahun) === Number(year));

    // sort by tanggal agar kronologis
    tx.sort((a,b)=>{
      const da = new Date(a.tanggal || '1970-01-01');
      const db = new Date(b.tanggal || '1970-01-01');
      return da - db;
    });

    // build HTML (rapi, baris ke bawah)
    let html = "";

    // header gambar (untuk print juga)
    if(cfg.header_url){
      html += `<div style="text-align:center;margin-bottom:6px;"><img src="${cfg.header_url}" style="max-width:720px;width:100%;height:auto;"></div>`;
    }

    // judul & bulan
    html += `<h2 style="text-align:center;margin:6px 0;">Buku Kas Umum<br>${cleanQuotes(cfg.subyek || "")}</h2>`;
    html += `<div style="text-align:center;font-weight:600;margin-bottom:8px;">Laporan Bulanan â€“ ${monthName(month)} ${year}</div>`;

    // tanggal laporan (ditampilkan, tapi lokasi/tgl final juga di bawah sebelum tanda tangan)
    html += `<div style="text-align:center;margin-bottom:12px;">Tanggal Laporan: ${tanggalFormatted}</div>`;

    // tabel
    html += `<div class="table-wrapper"><table><thead><tr>
      <th style="width:48px">No</th>
      <th style="width:110px">Tgl</th>
      <th>Uraian</th>
      <th class="right">Penerimaan</th>
      <th class="right">Pengeluaran</th>
      <th class="right">Saldo</th>
      <th style="width:140px">Aksi</th>
    </tr></thead><tbody>`;

    // saldo awal
    let saldo = Number(saldoAwal);
    html += `<tr style="font-weight:700;background:#f6f7f9;">
      <td>1</td><td></td><td>Saldo Awal Bulan</td><td></td><td></td>
      <td class="right">${saldo.toLocaleString()}</td><td></td></tr>`;

    // simpan tx ke global for edit
    window.currentTransactions = tx.slice();

    // rows
    let idx = 2;
    let totalIn = 0, totalOut = 0;
    tx.forEach(t => {
      const masuk = (String(t.jenis).trim() === "Penerimaan") ? Number(t.nominal) : 0;
      const keluar = (String(t.jenis).trim() === "Pengeluaran") ? Number(t.nominal) : 0;
      totalIn += masuk; totalOut += keluar;
      saldo += masuk - keluar;

      html += `<tr>
        <td>${idx++}</td>
        <td>${t.tanggal || ""}</td>
        <td>${escapeHtml(t.uraian)}</td>
        <td class="right">${masuk? masuk.toLocaleString() : ""}</td>
        <td class="right">${keluar? keluar.toLocaleString() : ""}</td>
        <td class="right">${saldo.toLocaleString()}</td>
        <td>
          <button onclick="editTransaksi('${t.id}')" style="padding:6px;border-radius:6px;margin-right:6px;">Edit</button>
          <button onclick="hapusTransaksi('${t.id}')" class="btn-danger">Hapus</button>
        </td>
      </tr>`;
    });

    // footer totals
    html += `</tbody><tfoot><tr style="font-weight:700;background:#eaf2ff;">
      <td colspan="3" class="right">Jumlah</td>
      <td class="right">${totalIn.toLocaleString()}</td>
      <td class="right">${totalOut.toLocaleString()}</td>
      <td class="right">${saldo.toLocaleString()}</td>
      <td></td>
    </tr></tfoot></table></div>`;

    // lokasi + tanggal (DI BAWAH sebelum tanda tangan)
    html += `<div style="text-align:right;margin-top:18px;margin-bottom:6px;">${cleanQuotes(cfg.lokasi || "")}, ${tanggalFormatted}</div>`;

    // tanda tangan / nama Ketua & Bendahara (tanpa kutip)
    html += `<div class="sign-area">
      <div class="box">Ketua<br><br><br><b>${cleanQuotes(cfg.ketua || "")}</b></div>
      <div class="box">Bendahara<br><br><br><b>${cleanQuotes(cfg.bendahara || "")}</b></div>
    </div>`;

    document.getElementById('laporan').innerHTML = html;
    document.getElementById('loadingLaporan').style.display = 'none';
  }catch(err){
    console.error('loadAndRender error', err);
    document.getElementById('laporan').innerHTML = '<div class="small">Gagal memuat laporan. Periksa format CSV/config atau koneksi.</div>';
    document.getElementById('loadingLaporan').style.display = 'none';
  }
}

/* ================= CRUD: edit/update/delete (panggil Apps Script) ================= */
function editTransaksi(id){
  const t = (window.currentTransactions || []).find(x => String(x.id) === String(id));
  if(!t){ alert('Transaksi tidak ditemukan.'); return; }
  document.getElementById('edit_id').value = t.id;
  document.getElementById('edit_tanggal').value = t.tanggal;
  document.getElementById('edit_uraian').value = t.uraian;
  document.getElementById('edit_jenis').value = t.jenis;
  document.getElementById('edit_nominal').value = t.nominal;
  document.getElementById('modalEditBackdrop').style.display = 'flex';
}
function closeEditModal(){ document.getElementById('modalEditBackdrop').style.display = 'none'; }

async function updateData(){
  const id = document.getElementById('edit_id').value;
  const tanggal = document.getElementById('edit_tanggal').value;
  const uraian = document.getElementById('edit_uraian').value;
  const jenis = document.getElementById('edit_jenis').value;
  const nominal = document.getElementById('edit_nominal').value;
  if(!tanggal || !uraian || !jenis){ alert('Lengkapi data.'); return; }

  const fd = new FormData();
  fd.append('action','update');
  fd.append('id', id);
  fd.append('tanggal', tanggal);
  fd.append('uraian', uraian);
  fd.append('jenis', jenis);
  fd.append('nominal', toNumberNominal(nominal));

  try{
    document.getElementById('loading').style.display = 'block';
    const res = await fetch(APP_POST_URL, { method:'POST', body: fd });
    const js = await res.json();
    document.getElementById('loading').style.display = 'none';
    if(js.status === 'success'){
      closeEditModal();
      const m = Number(document.getElementById('bulan').value);
      const y = Number(document.getElementById('tahun').value);
      await loadAndRender(m,y);
      alert('Data berhasil diperbarui.');
    } else {
      alert('Gagal update: '+(js.message||'unknown'));
    }
  }catch(err){
    document.getElementById('loading').style.display = 'none';
    alert('Terjadi error saat update: '+err);
  }
}

async function hapusTransaksi(id){
  const alasan = prompt('Alasan penghapusan (opsional):');
  if(alasan === null) return;
  const fd = new FormData();
  fd.append('action','delete');
  fd.append('id', id);
  fd.append('alasan', alasan || '');
  try{
    document.getElementById('loading').style.display = 'block';
    const res = await fetch(APP_POST_URL, { method:'POST', body: fd });
    const js = await res.json();
    document.getElementById('loading').style.display = 'none';
    if(js.status === 'success'){
      const m = Number(document.getElementById('bulan').value);
      const y = Number(document.getElementById('tahun').value);
      await loadAndRender(m,y);
      alert('Transaksi dihapus.');
    } else {
      alert('Gagal hapus: '+(js.message||'unknown'));
    }
  }catch(err){
    document.getElementById('loading').style.display = 'none';
    alert('Terjadi error saat menghapus: '+err);
  }
}

/* ================= Dropdown init & events ================= */
function initMonthDropdown(){
  const sel = document.getElementById('bulan');
  sel.innerHTML = '';
  for(let i=1;i<=12;i++){
    const o = document.createElement('option'); o.value = i; o.textContent = monthName(i);
    sel.appendChild(o);
  }
  sel.value = new Date().getMonth()+1;
}
function initYearDropdown(){
  const sel = document.getElementById('tahun');
  sel.innerHTML = '';
  const thisYear = new Date().getFullYear();
  for(let y=thisYear-3;y<=thisYear+1;y++){
    const o = document.createElement('option'); o.value = y; o.textContent = y;
    sel.appendChild(o);
  }
  sel.value = thisYear;
}

/* ================= Submit form (simpan transaksi) ================= */
document.getElementById('formKas').addEventListener('submit', async function(e){
  e.preventDefault();
  const fd = new FormData(e.target);
  fd.set('nominal', toNumberNominal(fd.get('nominal')||''));
  try{
    document.getElementById('loading').style.display = 'block';
    const res = await fetch(APP_POST_URL, { method:'POST', body: fd });
    const text = await res.text();
    document.getElementById('msg').innerHTML = text;
    document.getElementById('loading').style.display = 'none';
    e.target.reset();
    // refresh report
    const m = Number(document.getElementById('bulan').value);
    const y = Number(document.getElementById('tahun').value);
    await loadAndRender(m,y);
  }catch(err){
    document.getElementById('loading').style.display = 'none';
    alert('Gagal simpan: '+err);
  }
});

/* tombol tampil */
document.getElementById('lihat').addEventListener('click', async function(){
  const m = Number(document.getElementById('bulan').value);
  const y = Number(document.getElementById('tahun').value);
  document.getElementById('laporan').innerHTML = '';
  document.getElementById('loadingLaporan').style.display = 'block';
  await loadAndRender(m,y);
});

/* ================= Boot sequence ================= */
initMonthDropdown();
initYearDropdown();
applyHeaderConfig();
// load default current month
(async ()=>{
  const m = Number(document.getElementById('bulan').value);
  const y = Number(document.getElementById('tahun').value);
  await loadAndRender(m,y);
})();
</script>
</body>
</html>
