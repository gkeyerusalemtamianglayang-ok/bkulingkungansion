<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aplikasi Buku Kas Umum Jemaat GKE Yerusalem Tamiang Layang</title>
<link rel="icon" href="" />
<style>
/* ---------- Basic ---------- */
body { font-family: "Segoe UI", Arial, sans-serif; margin:0; padding:0; background:#f5f6fa; color:#222; }
.container { max-width: 1000px; margin: 18px auto; padding: 12px; }
.card { background:white; padding:18px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.06); margin-bottom:18px; }

/* ---------- Header ---------- */
.header-img { width:100%; max-width:600px; height:auto; margin:0 auto 8px; display:block; }
.app-header { text-align:center; padding:18px 10px; background:#0b74de; color:white; border-bottom:4px solid rgba(0,0,0,0.04); }
.app-header .title { font-size:20px; font-weight:700; }
.app-header .subtitle { font-size:14px; opacity:0.95; margin-top:6px; }

/* ---------- Form ---------- */
label { display:block; margin-top:10px; font-weight:600; }
input, select, textarea { width:100%; padding:10px; border-radius:6px; border:1px solid #ccc; margin-top:6px; font-size:15px; box-sizing:border-box; }
button { background:#0b74de; color:white; padding:10px 14px; border:none; border-radius:8px; cursor:pointer; }
.btn-sm { display:inline-block; background:#0b74de; color:white; padding:8px 12px; border-radius:6px; text-decoration:none; }

/* ---------- Table ---------- */
.table-wrapper { overflow-x:auto; margin-top:12px; }
table { width:100%; border-collapse:collapse; }
th, td { padding:10px 8px; border-bottom:1px solid #e9eef6; text-align:left; vertical-align:middle; }
th { background:#eef6ff; font-weight:600; }
.right { text-align:right; }

/* ---------- Loading ---------- */
#loading, #loadingLaporan { display:none; text-align:center; padding:10px; margin-top:8px; color:#0b74de; font-weight:700; }
#loading b, #loadingLaporan b { animation: blink 1s infinite; }
@keyframes blink { 0%{opacity:.2}50%{opacity:1}100%{opacity:.2} }

/* ---------- Laporan filter bar ---------- */
.laporan-filter { display:flex; flex-wrap:wrap; gap:16px; margin-bottom:20px; padding:12px; background:#f0f4ff; border-radius:8px; border:1px solid #dce6ff; }
.filter-item { flex:1; min-width:150px; }
.filter-btn { min-width:140px; align-self:end; }

/* Buttons */
.btn-print-green { background:#28a745; color:white; border:none; padding:9px 14px; border-radius:6px; cursor:pointer; font-weight:600; }
.btn-print-green:hover { background:#1f8a38; }
.btn-edit { background:#0b74de; color:white; padding:6px 10px; border:none; border-radius:6px; margin-right:6px; cursor:pointer; }
.btn-danger { background:#c0392b; color:white; padding:6px 10px; border:none; border-radius:6px; cursor:pointer; }

.form-group { margin-bottom:16px; }
.btn-submit { width:100%; padding:12px; font-size:15px; border-radius:6px; background:#0b74de; color:white; border:none; cursor:pointer; margin-top:4px; }
.btn-submit:hover { background:#095fb7; }

/* ---------- Modal ---------- */
.modal-backdrop { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.35); z-index:9999; }
.modal-card { background:white; width:95%; max-width:480px; padding:16px; border-radius:8px; box-shadow:0 10px 40px rgba(0,0,0,0.15); }

/* ---------- Print / A4 ---------- */
@page { size: A4 portrait; margin:12mm !important; }
@media print {
  body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
  body * { visibility: hidden !important; }
  #laporan, #laporan * { visibility: visible !important; }
  #laporan { position: absolute; left:0; top:0; width:100%; }
  table { page-break-inside:auto; }
  thead { display: table-header-group; }
  tfoot { display: table-footer-group; }
  tr { page-break-inside:avoid; page-break-after:auto; }
  #laporan table { width:100%; font-size:12px; }
  .no-print { display:none !important; visibility:hidden !important; }
}

/* ---------- Utilities ---------- */
.small { font-size:13px; color:#666; }
.center { text-align:center; }
.sign-area { margin-top:36px; width:100%; display:flex; justify-content:space-between; gap:20px; }
.sign-area .box { text-align:center; width:48%; font-weight:700; }
@media (max-width:600px){ .app-header .title { font-size:18px; } .header-img { max-width:320px; } }
</style>
<!-- html2pdf (for download) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
</head>
<body>

<!-- App Header -->
<div class="app-header">
  <img id="headerImageTop" class="header-img" src="" alt="Header" />
  <div class="title">Aplikasi Buku Kas Umum</div>
  <div id="headerSubyekTop" class="subtitle"></div>
</div>

<div class="container">

  <!-- INPUT -->
  <div class="card">
    <h3>Input Transaksi</h3>
    <form id="formKas">
      <div class="form-group">
        <label>Tanggal</label>
        <input type="date" name="tanggal" required>
      </div>
      <div class="form-group">
        <label>Uraian</label>
        <input type="text" name="uraian" placeholder="Contoh: Persembahan Minggu" required>
      </div>
      <div class="form-group">
        <label>Jenis</label>
        <select name="jenis">
          <option value="Penerimaan">Penerimaan</option>
          <option value="Pengeluaran">Pengeluaran</option>
        </select>
      </div>
      <div class="form-group">
        <label>Nominal</label>
        <input type="text" name="nominal" placeholder="Masukkan angka tanpa titik" required>
      </div>
      <button class="btn-submit" type="submit">Simpan Transaksi</button>
    </form>
    <div id="loading" class="small"><b>Sedang memproses...</b></div>
    <div id="msg" class="small"></div>
  </div>

 <div class="card">
  <h3>Laporan Bulanan</h3>

<div class="laporan-filter" style="flex-direction:column;">

  <!-- ====== TANGGAL LAPORAN PALING ATAS ====== -->
  <h4>ðŸ”· Tanggal Laporan</h4>
  <div class="filter-item">
    <label>Tanggal Laporan (untuk cetak)</label>
    <input type="date" id="tanggalLaporan">
  </div>


  <!-- ====== BAGIAN 1: LAPORAN PER BULAN ====== -->
  <h4 style="margin-top:15px;">ðŸ”· Laporan Bulanan</h4>

  <!-- LAPORAN BULANAN -->
<div class="filter-item">
  <label>Pilih Bulan</label>
  <select id="bulan"></select>
</div>

<div class="filter-item">
  <label>Pilih Tahun</label>
  <select id="tahun"></select>
</div>

<div class="filter-item filter-btn">
  <button id="lihat">Tampilkan Laporan Bulanan</button>
</div>


  <!-- ====== BAGIAN 2: LAPORAN RENTANG BULAN ====== -->
  <h4 style="margin-top:20px;">ðŸ”· Laporan Rentang Bulan</h4>

  <div class="filter-item">
    <label>Dari Bulan</label>
    <select id="dariBulan"></select>
  </div>

  <div class="filter-item">
    <label>Sampai Bulan</label>
    <select id="sampaiBulan"></select>
  </div>

  <div class="filter-item filter-btn">
    <button id="lihatRentang">Laporan Rentang Bulan</button>
  </div>


  <!-- ====== DOWNLOAD PDF ====== -->
  <div class="filter-item filter-btn" style="margin-top:20px;">
    <button id="downloadPDF" class="btn-print-green">Download PDF</button>
  </div>

</div>

<div id="loadingLaporan" class="small"><b>Memuat laporan...</b></div>
<div id="laporan" style="margin-top:24px;"></div>

<!-- MODAL EDIT -->
<div id="modalEditBackdrop" class="modal-backdrop">
  <div class="modal-card">
    <h3>Edit Transaksi</h3>
    <input type="hidden" id="edit_id">
    <label>Tanggal</label>
    <input type="date" id="edit_tanggal">
    <label>Uraian</label>
    <input type="text" id="edit_uraian">
    <label>Jenis</label>
    <select id="edit_jenis">
      <option value="Penerimaan">Penerimaan</option>
      <option value="Pengeluaran">Pengeluaran</option>
    </select>
    <label>Nominal</label>
    <input type="text" id="edit_nominal">
    <div style="display:flex; gap:8px; margin-top:12px;">
      <button class="btn-cancel" onclick="closeEditModal()">Batal</button>
      <button class="btn-save" onclick="updateData()">Simpan</button>
    </div>
  </div>
</div>

<script>
/* ========== CONFIG ========== */
const APP_POST_URL = "https://script.google.com/macros/s/AKfycbw54wej60UYkvjTXfb7WNCLG-2LQEjM4KINEJCT8IDIUtGPKvZnTR5k2aUrTWbHWbG2/exec";
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR6SHdMmw12HIgkj1VrsZRSjHrQPzlDMceBg4zOGYp5V6GimreVYVt71pgKVWC1fmA428NkQYfs5Jaw/pub?gid=0&single=true&output=csv";
const CONFIG_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR6SHdMmw12HIgkj1VrsZRSjHrQPzlDMceBg4zOGYp5V6GimreVYVt71pgKVWC1fmA428NkQYfs5Jaw/pub?gid=747260588&single=true&output=csv";

/* ========== UTILITIES ========== */
function cleanQuotes(s){ if(s===null||s===undefined) return ""; return String(s).replace(/^"+|"+$/g,"").trim(); }
function monthName(n){ const m=["","Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","Nopember","Desember"]; return m[n]||""; }
function escapeHtml(s){ if(!s) return ""; return String(s).replace(/[&<>"']/g, ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[ch]); }
function toNumberNominal(s){ if(s===null||s===undefined) return 0; let cleaned=String(s).replace(/[^\d\-]/g,''); if(cleaned==="") return 0; return Number(cleaned); }

/* ========== Robust CSV parser handling quotes & multiline ========== */
function parseCSV(text){
  if(!text) return [];
  text = text.replace(/\r\n/g,"\n");
  const rows = [];
  let inside=false, cur="", row=[];
  for(let i=0;i<text.length;i++){
    const ch = text[i];
    if(ch === '"'){
      const next = text[i+1];
      if(inside && next === '"'){ cur += '"'; i++; continue; }
      inside = !inside; continue;
    }
    if(ch === ',' && !inside){ row.push(cur); cur=""; continue; }
    if(ch === '\n' && !inside){ row.push(cur); cur=""; rows.push(row); row=[]; continue; }
    cur += ch;
  }
  if(cur !== "" || row.length>0){ row.push(cur); rows.push(row); }
  if(rows.length===0) return [];
  const header = rows.shift().map(h=>cleanQuotes(h).trim());
  return rows.map(r=>{
    const obj={};
    for(let i=0;i<header.length;i++){ obj[header[i]] = cleanQuotes((r[i]!==undefined)? r[i] : ""); }
    return obj;
  });
}

/* ========== load config (header_url, subyek, ketua, bendahara, lokasi) ========== */
async function loadConfig(){
  try{
    const res = await fetch(CONFIG_URL, { cache:'no-store' });
    const txt = await res.text();
    const arr = parseCSV(txt);
    const cfg = {};
    arr.forEach(r=>{ if(r.key !== undefined) cfg[r.key] = cleanQuotes(r.value || ""); });
    return cfg;
  }catch(err){
    console.error("loadConfig", err);
    return {};
  }
}
async function applyHeaderConfig(){
  const cfg = await loadConfig();
  if(cfg.header_url) document.getElementById('headerImageTop').src = cfg.header_url;
  if(cfg.subyek) document.getElementById('headerSubyekTop').innerText = cleanQuotes(cfg.subyek);
}

/* ========== load all transaksi ========== */
async function loadAllTransactions(){
  const res = await fetch(CSV_URL, { cache:'no-store' });
  const txt = await res.text();
  const arr = parseCSV(txt);

  return arr.map(r => {
    const keys = Object.keys(r);
    const find = (k) => keys.find(x=> x.toLowerCase() === k) || null;

    const idKey = find('id');
    const tanggalKey = find('tanggal');
    const uraianKey = find('uraian');
    const jenisKey = find('jenis');
    const nominalKey = find('nominal');
    const bulanKey = find('bulan');
    const tahunKey = find('tahun');

    const rawTanggal = tanggalKey ? r[tanggalKey] : "";
    const rawUraian = uraianKey ? r[uraianKey] : "";
    const rawJenis = jenisKey ? r[jenisKey] : "";
    const rawNominal = nominalKey ? r[nominalKey] : "";
    const rawBulan = bulanKey ? r[bulanKey] : "";
    const rawTahun = tahunKey ? r[tahunKey] : "";

    let parsedDate = rawTanggal ? new Date(rawTanggal) : new Date(NaN);
    let bulan = parseInt(rawBulan) || (isNaN(parsedDate.getMonth()) ? 0 : parsedDate.getMonth()+1);
    let tahun = parseInt(rawTahun) || (isNaN(parsedDate.getFullYear()) ? new Date().getFullYear() : parsedDate.getFullYear());

    return {
      raw: r,
      id: idKey ? r[idKey] : "",
      tanggal: rawTanggal,
      uraian: rawUraian,
      jenis: rawJenis,
      nominal: toNumberNominal(rawNominal),
      bulan: bulan,
      tahun: tahun
    };
  });
}



/* Replace the placeholder block above with the real implementation below.
   (Some editors may accidentally keep the placeholder; ensure only one
   loadAllTransactions() definition exists â€” the real one follows.) */

async function loadAllTransactions(){
  const res = await fetch(CSV_URL, { cache:'no-store' });
  const txt = await res.text();
  const arr = parseCSV(txt);

  return arr.map(r => {
    const keys = Object.keys(r);
    const find = (k) => keys.find(x=> x.toLowerCase() === k) || null;

    const idKey = find('id');
    const tanggalKey = find('tanggal');
    const uraianKey = find('uraian');
    const jenisKey = find('jenis');
    const nominalKey = find('nominal');
    const bulanKey = find('bulan');
    const tahunKey = find('tahun');

    const rawTanggal = tanggalKey ? r[tanggalKey] : "";
    const rawUraian = uraianKey ? r[uraianKey] : "";
    const rawJenis = jenisKey ? r[jenisKey] : "";
    const rawNominal = nominalKey ? r[nominalKey] : "";
    const rawBulan = bulanKey ? r[bulanKey] : "";
    const rawTahun = tahunKey ? r[tahunKey] : "";

    let parsedDate = rawTanggal ? new Date(rawTanggal) : new Date(NaN);
    let bulan = parseInt(rawBulan) || (isNaN(parsedDate.getMonth()) ? 0 : parsedDate.getMonth() + 1);
    let tahun = parseInt(rawTahun) || (isNaN(parsedDate.getFullYear()) ? new Date().getFullYear() : parsedDate.getFullYear());

    return {
      raw: r,
      id: idKey ? (r[idKey] || "") : "",
      tanggal: rawTanggal || "",
      uraian: rawUraian || "",
      jenis: rawJenis || "",
      nominal: toNumberNominal(rawNominal),
      bulan: Number(bulan),
      tahun: Number(tahun)
    };
  });
}

/* ========== hitung saldo awal (akumulasi semua sebelum target month/year) ========== */
function hitungSaldoAwalSemua(semuaData, targetMonth, targetYear){
  let saldo = 0;
  semuaData.forEach(r=>{
    if( (r.tahun < targetYear) || (r.tahun === targetYear && r.bulan < targetMonth) ){
      if(String(r.jenis).trim() === "Penerimaan") saldo += Number(r.nominal);
      if(String(r.jenis).trim() === "Pengeluaran") saldo -= Number(r.nominal);
    }
  });
  return saldo;
}

/* ========== render laporan ========== */
async function loadAndRender(month, year){
  try{
    document.getElementById('loadingLaporan').style.display = 'block';
    const cfg = await loadConfig();
    const tanggalDipilih = document.getElementById('tanggalLaporan').value;
    let tanggalFormatted = tanggalDipilih ? new Date(tanggalDipilih).toLocaleDateString('id-ID',{day:'numeric',month:'long',year:'numeric'})
                                          : new Date().toLocaleDateString('id-ID',{day:'numeric',month:'long',year:'numeric'});

    const semua = await loadAllTransactions();

    const saldoAwal = hitungSaldoAwalSemua(semua, month, year);

    let tx = semua.filter(r => Number(r.bulan) === Number(month) && Number(r.tahun) === Number(year));

    tx.sort((a,b)=>{
      const da = new Date(a.tanggal || '1970-01-01'), db = new Date(b.tanggal || '1970-01-01');
      return da - db;
    });

    let html = "";
    if(cfg.header_url) html += `<div style="text-align:center;margin-bottom:6px;"><img src="${cfg.header_url}" style="max-width:720px;width:100%;height:auto;"></div>`;
    html += `<h2 style="text-align:center;margin:6px 0;">Buku Kas Umum<br>${cleanQuotes(cfg.subyek || "")}</h2>`;
    html += `<div style="text-align:center;font-weight:600;margin-bottom:8px;">Laporan Bulanan â€“ ${monthName(month)} ${year}</div>`;
    html += `<div style="text-align:center;margin-bottom:12px;">Tanggal Laporan: ${tanggalFormatted}</div>`;

    html += `<div class="table-wrapper"><table><thead><tr>
      <th style="width:48px">No</th>
      <th style="width:110px">Tgl</th>
      <th>Uraian</th>
      <th class="right">Penerimaan</th>
      <th class="right">Pengeluaran</th>
      <th class="right">Saldo</th>
      <th style="width:140px" class="no-print">Aksi</th>
    </tr></thead><tbody>`;

    let saldo = Number(saldoAwal);
    html += `<tr style="font-weight:700;background:#f6f7f9;">
      <td>1</td><td></td><td>Saldo Awal Bulan</td><td></td><td></td><td class="right">${saldo.toLocaleString()}</td><td class="no-print"></td>
    </tr>`;

    window.currentTransactions = tx.slice();

    let idx = 2, totalIn = 0, totalOut = 0;
    tx.forEach(t=>{
      const masuk = (String(t.jenis).trim() === "Penerimaan") ? Number(t.nominal) : 0;
      const keluar = (String(t.jenis).trim() === "Pengeluaran") ? Number(t.nominal) : 0;
      totalIn += masuk; totalOut += keluar; saldo += masuk - keluar;

      html += `<tr>
        <td>${idx++}</td>
        <td>${t.tanggal || ""}</td>
        <td>${escapeHtml(t.uraian)}</td>
        <td class="right">${masuk? masuk.toLocaleString():""}</td>
        <td class="right">${keluar? keluar.toLocaleString():""}</td>
        <td class="right">${saldo.toLocaleString()}</td>
        <td class="no-print">
          <button class="btn-edit no-print" onclick="editTransaksi('${t.id}')">Edit</button>
          <button class="btn-danger no-print" onclick="hapusTransaksi('${t.id}')">Hapus</button>
        </td>
      </tr>`;
    });

    html += `</tbody><tfoot><tr style="font-weight:700;background:#eaf2ff;">
      <td colspan="3" class="right">Jumlah</td>
      <td class="right">${totalIn.toLocaleString()}</td>
      <td class="right">${totalOut.toLocaleString()}</td>
      <td class="right">${saldo.toLocaleString()}</td>
      <td class="no-print"></td>
    </tr></tfoot></table></div>`;

    html += `<div style="text-align:right;margin-top:18px;margin-bottom:6px;">${cleanQuotes(cfg.lokasi||"")}, ${tanggalFormatted}</div>`;
    html += `<div class="sign-area"><div class="box">Ketua<br><br><br><b>${cleanQuotes(cfg.ketua||"")}</b></div><div class="box">Bendahara<br><br><br><b>${cleanQuotes(cfg.bendahara||"")}</b></div></div>`;

    document.getElementById('laporan').innerHTML = html;
    document.getElementById('loadingLaporan').style.display = 'none';
  }catch(err){
    console.error("loadAndRender error", err);
    document.getElementById('laporan').innerHTML = '<div class="small">Gagal memuat laporan. Periksa CSV/config atau koneksi. Lihat console untuk detail.</div>';
    document.getElementById('loadingLaporan').style.display = 'none';
  }
}
async function loadRentang(dari, sampai, year){
  document.getElementById('loadingLaporan').style.display = 'block';

  const cfg = await loadConfig();
  const semua = await loadAllTransactions();

  // Filter data sesuai tahun & rentang bulan
  let tx = semua.filter(r =>
    Number(r.tahun) === Number(year) &&
    Number(r.bulan) >= Number(dari) &&
    Number(r.bulan) <= Number(sampai)
  );

  // Sort tanggal
  tx.sort((a,b)=> new Date(a.tanggal) - new Date(b.tanggal));

  // SALDO AWAL = bulan sebelum "dari"
  const saldoAwal = hitungSaldoAwalSemua(semua, dari, year);

  let saldo = saldoAwal;
  let totalIn = 0, totalOut = 0;

  let html = "";

  if(cfg.header_url)
    html += `<div style="text-align:center;margin-bottom:6px;"><img src="${cfg.header_url}"
              style="max-width:720px;width:100%;height:auto;"></div>`;

  html += `<h2 style="text-align:center;margin:6px 0;">Buku Kas Umum<br>${cfg.subyek}</h2>`;
  html += `<div style="text-align:center;font-weight:600;margin-bottom:8px;">
             Laporan Rentang Bulan: ${monthName(dari)} â€“ ${monthName(sampai)} ${year}
           </div>`;

  html += `<div class="table-wrapper"><table><thead><tr>
    <th>No</th><th>Tanggal</th><th>Uraian</th>
    <th class="right">Penerimaan</th>
    <th class="right">Pengeluaran</th>
    <th class="right">Saldo</th>
    <th class="no-print">Aksi</th>
  </tr></thead><tbody>`;

  html += `<tr style="font-weight:700;background:#f6f7f9;">
    <td>1</td><td></td><td>Saldo Awal</td><td></td><td></td>
    <td class="right">${saldo.toLocaleString()}</td><td class="no-print"></td>
  </tr>`;

  let no = 2;

  tx.forEach(t=>{
    const masuk  = t.jenis === "Penerimaan" ? t.nominal : 0;
    const keluar = t.jenis === "Pengeluaran" ? t.nominal : 0;

    saldo += masuk - keluar;
    totalIn += masuk;
    totalOut += keluar;

    html += `<tr>
      <td>${no++}</td>
      <td>${t.tanggal}</td>
      <td>${escapeHtml(t.uraian)}</td>
      <td class="right">${masuk? masuk.toLocaleString() : ""}</td>
      <td class="right">${keluar? keluar.toLocaleString() : ""}</td>
      <td class="right">${saldo.toLocaleString()}</td>
      <td class="no-print">
        <button class="btn-edit" onclick="editTransaksi('${t.id}')">Edit</button>
        <button class="btn-danger" onclick="hapusTransaksi('${t.id}')">Hapus</button>
      </td>
    </tr>`;
  });

  html += `</tbody><tfoot><tr style="font-weight:700;background:#eaf2ff;">
    <td colspan="3" class="right">Jumlah</td>
    <td class="right">${totalIn.toLocaleString()}</td>
    <td class="right">${totalOut.toLocaleString()}</td>
    <td class="right">${saldo.toLocaleString()}</td>
    <td class="no-print"></td>
  </tr></tfoot></table></div>`;

  document.getElementById('laporan').innerHTML = html;
  document.getElementById('loadingLaporan').style.display = 'none';
}
/* ========== render laporan rentang bulan ========== */
async function loadAndRenderRange(dariBulan, sampaiBulan, tahun) {
  try {
    document.getElementById('loadingLaporan').style.display = 'block';

    const cfg = await loadConfig();
    const tanggalDipilih = document.getElementById('tanggalLaporan').value;
    let tanggalFormatted = tanggalDipilih
      ? new Date(tanggalDipilih).toLocaleDateString('id-ID', { day:'numeric', month:'long', year:'numeric' })
      : new Date().toLocaleDateString('id-ID', { day:'numeric', month:'long', year:'numeric' });

    const semua = await loadAllTransactions();

    /* saldo awal = semua transaksi sebelum 'dariBulan' */
    const saldoAwal = hitungSaldoAwalSemua(semua, dariBulan, tahun);

    /* ambil transaksi rentang bulan */
    let tx = semua.filter(r =>
      r.tahun === tahun &&
      r.bulan >= dariBulan &&
      r.bulan <= sampaiBulan
    );

    /* urutkan berdasarkan tanggal ASC */
    tx.sort((a,b) => new Date(a.tanggal) - new Date(b.tanggal));

    /* mulai membuat HTML laporan */
    let html = "";

    if(cfg.header_url){
      html += `
        <div style="text-align:center;margin-bottom:6px;">
          <img src="${cfg.header_url}" style="max-width:720px;width:100%;height:auto;">
        </div>`;
    }

    html += `
    <h2 style="text-align:center;margin:6px 0;">
      Buku Kas Umum<br>${cleanQuotes(cfg.subyek || "")}
    </h2>

    <div style="text-align:center;font-weight:600;margin-bottom:8px;">
      Laporan Rentang Bulan â€“ ${monthName(dariBulan)} s/d ${monthName(sampaiBulan)} ${tahun}
    </div>

    <div style="text-align:center;margin-bottom:12px;">
      Tanggal Laporan: ${tanggalFormatted}
    </div>
    `;

    html += `
    <div class="table-wrapper"><table><thead><tr>
      <th style="width:48px">No</th>
      <th style="width:110px">Tgl</th>
      <th>Bulan</th>
      <th>Uraian</th>
      <th class="right">Penerimaan</th>
      <th class="right">Pengeluaran</th>
      <th class="right">Saldo</th>
      <th style="width:140px" class="no-print">Aksi</th>
    </tr></thead><tbody>`;

    let saldo = Number(saldoAwal);

    /* saldo awal */
    html += `
      <tr style="font-weight:700;background:#f6f7f9;">
        <td>1</td>
        <td></td>
        <td>${monthName(dariBulan)}</td>
        <td>Saldo Awal</td>
        <td></td>
        <td></td>
        <td class="right">${saldo.toLocaleString()}</td>
        <td class="no-print"></td>
      </tr>
    `;

    window.currentTransactions = tx.slice();

    let idx = 2, totalIn = 0, totalOut = 0;

    tx.forEach(t => {
      const masuk = t.jenis === "Penerimaan" ? t.nominal : 0;
      const keluar = t.jenis === "Pengeluaran" ? t.nominal : 0;
      totalIn += masuk;
      totalOut += keluar;
      saldo += masuk - keluar;

      /* Pada laporan rentang bulan â€” Aksi edit/hapus hanya untuk bulan pertama */
      let aksiBtn = "";
      if(t.bulan === dariBulan){
        aksiBtn = `
          <button class="btn-edit no-print" onclick="editTransaksi('${t.id}')">Edit</button>
          <button class="btn-danger no-print" onclick="hapusTransaksi('${t.id}')">Hapus</button>
        `;
      }

      html += `
        <tr>
          <td>${idx++}</td>
          <td>${t.tanggal}</td>
          <td>${monthName(t.bulan)}</td>
          <td>${escapeHtml(t.uraian)}</td>
          <td class="right">${masuk ? masuk.toLocaleString() : ""}</td>
          <td class="right">${keluar ? keluar.toLocaleString() : ""}</td>
          <td class="right">${saldo.toLocaleString()}</td>
          <td class="no-print">${aksiBtn}</td>
        </tr>`;
    });

    html += `
      </tbody>
      <tfoot><tr style="font-weight:700;background:#eaf2ff;">
        <td colspan="4" class="right">Total</td>
        <td class="right">${totalIn.toLocaleString()}</td>
        <td class="right">${totalOut.toLocaleString()}</td>
        <td class="right">${saldo.toLocaleString()}</td>
        <td class="no-print"></td>
      </tr></tfoot>
      </table></div>
    `;

    html += `
      <div style="text-align:right;margin-top:18px;margin-bottom:6px;">
        ${cleanQuotes(cfg.lokasi || "")}, ${tanggalFormatted}
      </div>

      <div class="sign-area">
        <div class="box">Ketua<br><br><br><b>${cleanQuotes(cfg.ketua || "")}</b></div>
        <div class="box">Bendahara<br><br><br><b>${cleanQuotes(cfg.bendahara || "")}</b></div>
      </div>
    `;

    document.getElementById('laporan').innerHTML = html;
    document.getElementById('loadingLaporan').style.display = 'none';

  } catch (err) {
    console.error("loadAndRenderRange error", err);
    document.getElementById('laporan').innerHTML =
      '<div class="small">Gagal memuat laporan rentang bulan.</div>';
    document.getElementById('loadingLaporan').style.display = 'none';
  }
}

/* ========== CRUD ========== */
function editTransaksi(id){
  const t = (window.currentTransactions || []).find(x => String(x.id) === String(id));
  if(!t){ alert("Transaksi tidak ditemukan."); return; }
  document.getElementById('edit_id').value = t.id;
  document.getElementById('edit_tanggal').value = t.tanggal;
  document.getElementById('edit_uraian').value = t.uraian;
  document.getElementById('edit_jenis').value = t.jenis;
  document.getElementById('edit_nominal').value = t.nominal;
  document.getElementById('modalEditBackdrop').style.display = 'flex';
}
function closeEditModal(){ document.getElementById('modalEditBackdrop').style.display = 'none'; }

async function updateData(){
  const id = document.getElementById('edit_id').value;
  const tanggal = document.getElementById('edit_tanggal').value;
  const uraian = document.getElementById('edit_uraian').value;
  const jenis = document.getElementById('edit_jenis').value;
  const nominal = document.getElementById('edit_nominal').value;
  if(!tanggal || !uraian || !jenis){ alert("Lengkapi data."); return; }

  const fd = new FormData();
  fd.append('action','update'); fd.append('id', id);
  fd.append('tanggal', tanggal); fd.append('uraian', uraian);
  fd.append('jenis', jenis); fd.append('nominal', toNumberNominal(nominal));

  try{
    document.getElementById('loading').style.display = 'block';
    const res = await fetch(APP_POST_URL, { method:'POST', body: fd });
    const js = await res.json();
    document.getElementById('loading').style.display = 'none';
    if(js.status === 'success'){ closeEditModal(); await loadAndRender(Number(document.getElementById('bulan').value), Number(document.getElementById('tahun').value)); alert('Data berhasil diperbarui.'); }
    else alert('Gagal update: ' + (js.message || 'unknown'));
  }catch(err){
    document.getElementById('loading').style.display = 'none';
    alert('Terjadi error: ' + err);
  }
}

async function hapusTransaksi(id){
  const alasan = prompt('Alasan penghapusan (opsional):');
  if(alasan === null) return;
  const fd = new FormData(); fd.append('action','delete'); fd.append('id', id); fd.append('alasan', alasan || '');
  try{
    const res = await fetch(APP_POST_URL, { method:'POST', body: fd });
    const js = await res.json();
    if(js.status === 'success'){ await loadAndRender(Number(document.getElementById('bulan').value), Number(document.getElementById('tahun').value)); alert('Transaksi dihapus.'); }
    else alert('Gagal hapus: ' + (js.message || 'unknown'));
  }catch(err){ alert('Error hapus: '+err); }
}

/* ========== RENTANG DROPDOWN ONLY (karena bulan/tahun tunggal sudah DIHAPUS) ========== */
function initRentangDropdown(){
  const db = document.getElementById('dariBulan');
  const sb = document.getElementById('sampaiBulan');
  if(!db || !sb) return;

  db.innerHTML = "";
  sb.innerHTML = "";

  for(let i=1;i<=12;i++){
    const o1 = document.createElement('option');
    const o2 = document.createElement('option');
    o1.value = o2.value = i;
    o1.textContent = o2.textContent = monthName(i);
    db.appendChild(o1);
    sb.appendChild(o2);
  }

  db.value = 1;
  sb.value = new Date().getMonth()+1;
}

/* ========== EVENT SIMPAN TRANSAKSI ========== */
document.getElementById('formKas').addEventListener('submit', async function(e){
  e.preventDefault();
  const fd = new FormData(e.target);
  fd.set('nominal', toNumberNominal(fd.get('nominal')||''));
  try{
    document.getElementById('loading').style.display = 'block';
    const res = await fetch(APP_POST_URL, { method:'POST', body: fd });
    document.getElementById('loading').style.display = 'none';
    e.target.reset();
    alert("Transaksi berhasil disimpan.");
  }catch(err){
    document.getElementById('loading').style.display = 'none';
    alert('Gagal simpan: '+err);
  }
});

/* ========== EVENT LAPORAN BULANAN (khusus 1 bulan) ========== */
document.getElementById('lihat').addEventListener('click', async function(){
  const m = Number(document.getElementById('bulan').value);
  const y = Number(document.getElementById('tahun').value);

  if(!m || !y){
    alert("Pilih bulan & tahun.");
    return;
  }

  document.getElementById('laporan').innerHTML = '';
  document.getElementById('loadingLaporan').style.display = 'block';

  await loadAndRender(m,y);
});

/* ========== EVENT LAPORAN RENTANG BULAN ========== */
document.getElementById('lihatRentang').addEventListener('click', async ()=>{
  const dari = Number(document.getElementById('dariBulan').value);
  const sampai = Number(document.getElementById('sampaiBulan').value);
  const year = new Date().getFullYear();

  if(sampai < dari){
    alert("Bulan akhir harus >= bulan awal.");
    return;
  }

  document.getElementById('laporan').innerHTML = '';
  document.getElementById('loadingLaporan').style.display = 'block';

  await loadRentang(dari, sampai, year);
});

/* ========== DOWNLOAD PDF ========== */
document.getElementById('downloadPDF').addEventListener('click', function(){
  const original = document.getElementById('laporan');
  if(!original.innerHTML.trim()){
    alert('Tampilkan laporan dulu.');
    return;
  }
  const clone = original.cloneNode(true);
  clone.querySelectorAll('.no-print, button').forEach(n => n.remove());
  html2pdf().set({
    margin: 10,
    filename: `Laporan_Kas_${new Date().toISOString().slice(0,10)}.pdf`,
    image: { type: 'jpeg', quality: 1 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  }).from(clone).save();
});

/* ========== BOOT ========== */
/* Tidak ada loadAndRender otomatis! */
initRentangDropdown();
applyHeaderConfig();


</script>
</body>
</html>
